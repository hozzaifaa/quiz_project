<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Dynamic Multi-Quiz App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- MathJax Config -->
  <script>
  window.MathJax = {
    tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
    svg: { fontCache: 'global' }
  };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    body { background: #f8f9fa; }
    .card { margin-bottom: 20px; }
    .feedback { margin-top: 10px; font-size: 0.95rem; }
    .correct { color: green; font-weight: bold; }
    .wrong { color: red; font-weight: bold; }
    #scoreBox { margin-top: 20px; font-size: 1.2rem; font-weight: bold; }
    .quiz-link { display: flex; justify-content: space-between; }
    .score-label { font-size: 0.9rem; color: #555; }

    /* üåô Dark Mode */
    body.dark-mode { background: #121212; color: #e0e0e0; }
    body.dark-mode .card { background: #1e1e1e; border: 1px solid #333; color: #e0e0e0; }
    body.dark-mode h1, body.dark-mode h3, body.dark-mode h5 { color: #e0e0e0; }
    body.dark-mode .btn { border-color: #444; }
    body.dark-mode .MathJax { color: #e0e0e0 !important; }
    body.dark-mode .feedback { color: #bbb !important; }

    /* ‚úÖ Floating Sidebar */
    #sidebar { width: 250px; }
    #sidebar .nav-link {
      color: #000;
      padding: 10px;
      border-radius: 6px;
    }
    #sidebar .nav-link.active {
      background: #0d6efd;
      color: #fff;
    }

    /* Sidebar Dark */
    body.dark-mode #sidebar { background: #1f1f1f; color: #e0e0e0; }
    body.dark-mode #sidebar .nav-link { color: #bbb; }
    body.dark-mode #sidebar .nav-link.active { background: #0d6efd; color: #fff; }

    /* ‚úÖ Navbar Light & Dark */
    .navbar-custom { transition: all 0.3s ease; }
    body.dark-mode .navbar-custom {
      background-color: #1f1f1f !important;
    }
    body.dark-mode .navbar-custom h4,
    body.dark-mode .navbar-custom button {
      color: #e0e0e0 !important;
    }
  </style>
</head>
<body>
  <!-- Top Navbar -->
  <nav class="navbar navbar-light bg-light navbar-custom px-3">
    <button class="btn btn-outline-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar">
      ‚ò∞ Menu
    </button>
    <h4 class="mx-auto mb-0" id="quizTitle">üìò Class Quiz</h4>
    <button id="darkModeBtn" class="btn btn-sm btn-outline-secondary">üåô</button>
  </nav>

  <!-- Sidebar -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebar">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Choose a Quiz</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column" id="quizList"></ul>
      <hr>
      <button id="clearScoresBtn" class="btn btn-danger btn-sm mt-2">Clear All Quizzes</button>
    </div>
  </div>

  <!-- Main -->
  <main class="container p-4">
    <div id="quiz-container">üëâ Select a quiz from the menu</div>

    <div class="text-center mt-4">
      <button id="finishBtn" class="btn btn-success me-2" disabled>Submit</button>
      <button id="resetBtn" class="btn btn-secondary me-2" disabled>Reset</button>
    </div>

    <div id="scoreBox" class="text-center"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="manifest.js"></script>

  <script>
    const container = document.getElementById('quiz-container');
    const scoreBox = document.getElementById('scoreBox');
    const quizTitleEl = document.getElementById('quizTitle');
    const finishBtn = document.getElementById('finishBtn');
    const resetBtn = document.getElementById('resetBtn');
    const clearScoresBtn = document.getElementById('clearScoresBtn');
    const darkModeBtn = document.getElementById('darkModeBtn');
    const quizList = document.getElementById('quizList');
    const sidebarEl = document.getElementById('sidebar');
    const sidebarOffcanvas = new bootstrap.Offcanvas(sidebarEl);

    let currentQuiz = [];
    let currentQuizFile = null;
    let scores = JSON.parse(localStorage.getItem("quizScores") || "{}");

    function saveScores() { localStorage.setItem("quizScores", JSON.stringify(scores)); }
    function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

    function renderQuiz() {
      container.innerHTML = '';
      currentQuiz.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'card p-3 shadow-sm';
        const qTitle = document.createElement('h5');
        qTitle.innerHTML = `Q${idx + 1}: ${q.question}`;
        card.appendChild(qTitle);

        shuffle(q.options).forEach(opt => {
          const div = document.createElement('div');
          div.className = 'form-check';
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'q' + idx;
          input.value = opt;
          input.className = 'form-check-input';
          div.appendChild(input);
          const label = document.createElement('label');
          label.className = 'form-check-label';
          label.innerHTML = opt;
          div.appendChild(label);
          card.appendChild(div);
        });

        const feedback = document.createElement('div');
        feedback.className = 'feedback text-muted';
        feedback.textContent = 'No answer yet.';
        card.appendChild(feedback);

        container.appendChild(card);
      });

      finishBtn.disabled = false;
      resetBtn.disabled = false;
      if (window.MathJax) MathJax.typesetPromise([container]);
    }

    function gradeQuiz() {
      let studentAnswers = {}, feedbackData = {};
      for (let idx = 0; idx < currentQuiz.length; idx++) {
        const card = container.children[idx];
        const selected = card.querySelector('input[type=radio]:checked');
        if (!selected) { alert("‚ö†Ô∏è Please answer all questions before submitting."); return; }
        studentAnswers["q" + idx] = selected.value;
      }

      let correct = 0;
      currentQuiz.forEach((q, idx) => {
        const card = container.children[idx];
        const selected = card.querySelector('input[type=radio]:checked');
        const feedback = card.querySelector('.feedback');
        if (selected.value === q.answer) {
          correct++;
          feedback.className = 'feedback correct';
          feedback.textContent = '‚úÖ Correct!';
        } else {
          feedback.className = 'feedback wrong';
          feedback.innerHTML = `‚ùå Wrong. Correct: <b>${q.answer}</b><br><small>${q.explain||''}</small>`;
        }
        feedbackData["q" + idx] = feedback.innerHTML;
      });

      let badge = (correct === currentQuiz.length) ? " üèÜ" : "";
      scoreBox.textContent = `Final Score: ${correct}/${currentQuiz.length}${badge}`;

      scores[currentQuizFile] = { score: `${correct}/${currentQuiz.length}${badge}`, answers: studentAnswers, feedback: feedbackData };
      saveScores(); updateSidebarScores();

      container.querySelectorAll("input[type=radio]").forEach(r => r.disabled = true);

      finishBtn.disabled = true;
      resetBtn.disabled = false;
    }

    function loadQuiz(file, title=null) {
      currentQuizFile = file;
      delete window.quiz;
      const old = document.getElementById('quizScript'); if (old) old.remove();
      const script = document.createElement('script');
      script.src = file + '?t=' + Date.now(); script.id = 'quizScript';
      script.onload = () => {
        if (window.quiz) {
          currentQuiz = shuffle(window.quiz.slice());
          renderQuiz();

          const finalTitle = title || window.quizTitle || file;
          quizTitleEl.textContent = "üìò " + finalTitle;

          localStorage.setItem("lastQuiz", JSON.stringify({file, title: finalTitle}));
          setActiveLink(file);

          // Auto-close sidebar after selecting a quiz
          sidebarOffcanvas.hide();

          if (scores[file]) {
            let saved = scores[file];
            Object.keys(saved.answers).forEach(key => {
              const idx = parseInt(key.substring(1));
              const value = saved.answers[key];
              const radios = container.querySelectorAll(`input[name=q${idx}]`);
              radios.forEach(r => { if (r.value === value) r.checked = true; });
            });
            Object.keys(saved.feedback).forEach(key => {
              const idx = parseInt(key.substring(1));
              container.children[idx].querySelector('.feedback').innerHTML = saved.feedback[key];
            });
            container.querySelectorAll("input[type=radio]").forEach(r => r.disabled = true);
            finishBtn.disabled = true;
            resetBtn.disabled = false;
            scoreBox.textContent = "Previous Score: " + saved.score;
          } else {
            scoreBox.textContent = '';
            finishBtn.disabled = false;
            resetBtn.disabled = false;
          }
          if (window.MathJax) MathJax.typesetPromise([container]);
        }
      };
      document.body.appendChild(script);
    }

    function clearAllScores() {
      scores = {}; saveScores(); updateSidebarScores();
      scoreBox.textContent = ''; alert("‚úÖ All quizzes cleared. Students can retake.");
    }

    function updateSidebarScores() {
      quizList.querySelectorAll('a').forEach(link => {
        const file = link.dataset.file;
        const scoreSpan = link.querySelector('.score-label');
        scoreSpan.textContent = scores[file] ? scores[file].score : '';
      });
    }

    function setActiveLink(file) {
      quizList.querySelectorAll('a').forEach(link => {
        link.classList.toggle("active", link.dataset.file === file);
      });
    }

    // Dark Mode
    function setDarkMode(enable) {
      document.body.classList.toggle('dark-mode', enable);
      localStorage.setItem('darkMode', enable);
      const navbar = document.querySelector('.navbar-custom');
      if (enable) {
        navbar.classList.remove('bg-light', 'navbar-light');
        navbar.classList.add('bg-dark', 'navbar-dark');
      } else {
        navbar.classList.remove('bg-dark', 'navbar-dark');
        navbar.classList.add('bg-light', 'navbar-light');
      }
    }
    if (localStorage.getItem('darkMode')==='true') setDarkMode(true);
    darkModeBtn.onclick = () => setDarkMode(!document.body.classList.contains('dark-mode'));

    // Sidebar from manifest.js
    window.quizManifest.forEach(item => {
      const li=document.createElement('li'); li.className='nav-item';
      const a=document.createElement('a'); a.href='#'; a.className="nav-link quiz-link"; a.dataset.file=item.file;
      a.innerHTML=`<span>${item.title}</span><span class="score-label"></span>`;
      a.onclick=(e)=>{e.preventDefault(); loadQuiz(item.file, item.title);};
      li.appendChild(a); quizList.appendChild(li);
    });
    updateSidebarScores();

    const last=localStorage.getItem("lastQuiz");
    if(last) {
      const {file, title} = JSON.parse(last);
      loadQuiz(file, title);
    }

    finishBtn.onclick=gradeQuiz;
    resetBtn.onclick=()=>{ 
      if (currentQuizFile && scores[currentQuizFile]) {
        delete scores[currentQuizFile];
        saveScores();
        updateSidebarScores();
      }
      scoreBox.textContent='';
      loadQuiz(currentQuizFile);
    };
    clearScoresBtn.onclick=clearAllScores;
  </script>
</body>
</html>
