<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Dynamic Multi-Quiz App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .sidebar { min-height: 100vh; background: #fff; border-right: 1px solid #ddd; padding: 20px; }
    .card { margin-bottom: 20px; }
    .feedback { margin-top: 10px; font-size: 0.95rem; }
    .correct { color: green; font-weight: bold; }
    .wrong { color: red; font-weight: bold; }
    #scoreBox { margin-top: 20px; font-size: 1.2rem; font-weight: bold; }
    .quiz-link { display: flex; justify-content: space-between; }
    .score-label { font-size: 0.9rem; color: #555; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-3 col-lg-2 sidebar">
        <h4>Choose a Quiz</h4>
        <ul class="nav flex-column" id="quizList"></ul>
      </nav>

      <!-- Main content -->
      <main class="col-md-9 col-lg-10 p-4">
        <h1 class="text-center mb-4">üìò Class Quiz</h1>
        <div id="quiz-container">üëâ Select a quiz from the sidebar</div>

        <div class="text-center mt-4">
          <button id="finishBtn" class="btn btn-success me-2" disabled>Finish & Score</button>
          <button id="resetBtn" class="btn btn-secondary" disabled>Reset</button>
        </div>

        <div id="scoreBox" class="text-center"></div>
      </main>
    </div>
  </div>

  <!-- Load manifest -->
  <script src="manifest.js"></script>

  <script>
    const container = document.getElementById('quiz-container');
    const finishBtn = document.getElementById('finishBtn');
    const resetBtn = document.getElementById('resetBtn');
    const scoreBox = document.getElementById('scoreBox');
    const quizList = document.getElementById('quizList');

    let currentQuiz = [];
    let currentQuizFile = null;
    let scores = {};

    function shuffle(array) {
      return array.sort(() => Math.random() - 0.5);
    }

    function renderQuiz() {
      container.innerHTML = '';
      currentQuiz = shuffle(window.quiz);
      currentQuiz.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'card p-3 shadow-sm';

        const qTitle = document.createElement('h5');
        qTitle.innerHTML = `Q${idx + 1}: ${q.question}`;
        card.appendChild(qTitle);

        shuffle(q.options).forEach(opt => {
          const div = document.createElement('div');
          div.className = 'form-check';
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = 'q' + idx;
          input.value = opt;
          input.className = 'form-check-input';
          const label = document.createElement('label');
          label.className = 'form-check-label';
          label.textContent = opt;
          div.appendChild(input);
          div.appendChild(label);
          card.appendChild(div);
        });

        const feedback = document.createElement('div');
        feedback.className = 'feedback text-muted';
        feedback.textContent = 'No answer yet.';
        card.appendChild(feedback);

        container.appendChild(card);
      });

      finishBtn.disabled = false;
      resetBtn.disabled = false;
    }

    function gradeQuiz() {
      let correct = 0;
      currentQuiz.forEach((q, idx) => {
        const card = container.children[idx];
        const selected = card.querySelector('input[type=radio]:checked');
        const feedback = card.querySelector('.feedback');

        if (selected && selected.value === q.answer) {
          correct++;
          feedback.className = 'feedback correct';
          feedback.textContent = '‚úÖ Correct!';
        } else {
          feedback.className = 'feedback wrong';
          feedback.innerHTML = `‚ùå Wrong. Correct: <b>${q.answer}</b><br><small>${q.explain || ''}</small>`;
        }
      });

      scoreBox.textContent = `Final Score: ${correct} / ${currentQuiz.length}`;
      scores[currentQuizFile] = `${correct}/${currentQuiz.length}`;
      updateSidebarScores();
    }

    function resetQuiz() {
      scoreBox.textContent = '';
      renderQuiz();
    }

    function updateSidebarScores() {
      [...quizList.querySelectorAll('a')].forEach(link => {
        const file = link.dataset.file;
        const scoreSpan = link.querySelector('.score-label');
        if (scores[file]) {
          scoreSpan.textContent = scores[file];
        } else {
          scoreSpan.textContent = '';
        }
      });
    }

    function loadQuiz(file) {
      currentQuizFile = file;
      const oldScript = document.getElementById('quizScript');
      if (oldScript) oldScript.remove();

      const script = document.createElement('script');
      script.src = file + '?t=' + Date.now();
      script.id = 'quizScript';
      script.onload = () => {
        if (window.quiz) {
          renderQuiz();
          scoreBox.textContent = '';
        }
      };
      document.body.appendChild(script);
    }

    // Build sidebar dynamically from manifest
    window.quizManifest.forEach(item => {
      const li = document.createElement('li');
      li.className = 'nav-item';
      const a = document.createElement('a');
      a.href = "#";
      a.className = "nav-link quiz-link";
      a.dataset.file = item.file;
      a.innerHTML = `<span>${item.title}</span><span class="score-label"></span>`;
      a.onclick = (e) => {
        e.preventDefault();
        loadQuiz(item.file);
      };
      li.appendChild(a);
      quizList.appendChild(li);
    });

    // Button actions
    finishBtn.onclick = gradeQuiz;
    resetBtn.onclick = resetQuiz;
  </script>
</body>
</html>
